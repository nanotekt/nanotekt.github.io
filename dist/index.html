<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>nanore</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;background:#0d0d1a;color:#c0c0d0;font-family:'Courier New',monospace;overflow:hidden}
#app{display:flex;height:100vh}
#render-panel{flex:1;display:flex;flex-direction:column;padding:12px;min-width:0}
#tab-bar{display:flex;gap:4px;margin-bottom:8px}
.tab{padding:6px 18px;background:#1a1a2e;border:1px solid #333;color:#777;cursor:pointer;font-family:inherit;font-size:13px;transition:all .15s}
.tab:hover{color:#aaa;border-color:#555}
.tab.active{background:#2a1a3e;color:#e0a0d0;border-color:#6a3a7a}
#canvas-wrap{position:relative;flex:1;display:flex;align-items:center;justify-content:center;background:#080810;border:1px solid #222;border-radius:4px;overflow:hidden}
canvas{max-width:100%;max-height:100%;image-rendering:auto}
#overlay{position:absolute;inset:0;display:none;flex-direction:column;align-items:center;justify-content:center;background:rgba(8,8,16,0.3);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);z-index:10}
#progress-track{width:50%;height:4px;background:#1a1a2e;border-radius:2px;overflow:hidden}
#progress-fill{height:100%;width:0%;background:linear-gradient(90deg,#e04080,#ff6090);transition:width .15s}
#progress-text{margin-top:8px;font-size:12px;color:#888}
#status{font-size:11px;color:#555;margin-top:6px;height:14px}
#editor-panel{width:440px;display:flex;flex-direction:column;border-left:1px solid #222}
#editor-header{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:#111;border-bottom:1px solid #222}
#editor-header span{font-size:13px;color:#888}
#render-btn{padding:5px 14px;background:#e04080;color:#fff;border:none;cursor:pointer;font-family:inherit;font-size:12px;border-radius:3px;transition:background .15s}
#render-btn:hover{background:#ff5090}
#render-btn:disabled{background:#555;cursor:default}
#yaml-editor{flex:1;padding:12px;background:#0a0a14;color:#b0b0c0;border:none;resize:none;font-family:'Courier New',monospace;font-size:12px;line-height:1.5;tab-size:2;outline:none;white-space:pre;overflow-wrap:normal;overflow-x:auto}
#yaml-editor::selection{background:#3a2a5a}
#error-bar{display:none;padding:6px 12px;background:#3a1020;color:#ff6080;font-size:12px;border-bottom:1px solid #552040}
</style>
</head>
<body>
<div id="app">
  <div id="render-panel">
    <div id="tab-bar">
      <button class="tab active" data-tab="color">Color</button>
      <button class="tab" data-tab="zbuffer">Z-buffer</button>
    </div>
    <div id="canvas-wrap">
      <canvas id="render-canvas" width="256" height="256"></canvas>
      <div id="overlay">
        <div id="progress-track"><div id="progress-fill"></div></div>
        <div id="progress-text">0%</div>
      </div>
    </div>
    <div id="status"></div>
  </div>
  <div id="editor-panel">
    <div id="editor-header">
      <span>Scene YAML</span>
      <button id="render-btn">Render</button>
    </div>
    <div id="error-bar"></div>
    <textarea id="yaml-editor" spellcheck="false">version: nanore@2

rendering:
  width: 1024
  height: 1024
  samples: 4
  fog_max_dist: 80.0

camera:
  position: [0, 5, 22]
  target: [0, 5, -20]

objects:
  nanotekt:
    type: bitmap_text
    bitmap:
      0: @...@..@@@..@...@..@@@..@@@@@.@@@@@.@...@.@@@@@
      1: @@..@.@...@.@@..@.@...@...@...@.....@..@....@..
      2: @.@.@.@@@@@.@.@.@.@...@...@...@@@@..@@@.....@..
      3: @..@@.@...@.@..@@.@...@...@...@.....@..@....@..
      4: @...@.@...@.@...@.@...@...@...@.....@...@...@..
      5: @...@.@...@.@...@..@@@....@...@@@@@.@...@...@..
    sphere_radius: 0.8
    x_offset: -23.0
    y_base: 23.0
    y_spacing: 0.9
    z_depth: -24.0
    slash_x_base: 0.0
    slash_y_base: 0.0
    slash_count: 0
  chrome_cubes:
    type: rounded_cube
    center: [0.0, 9.5, -24.0]
    rotation: [0.3, 0.5, 0.2]
    count: 256
    half_min: 0.3
    half_max: 1.2
    spread: 8.0
    round_ratio: 0.2
    seed: 42
  backdrop:
    type: disc
    center: [0.0, 6.5, -34.0]
    normal: [0.0, 0.0, 1.0]
    radius: 18.0
    emissive_color: [4.0, 0.05, 0.05]
    light_color: [4.0, 0.05, 0.05]
  floor:
    type: floor
    bounds_x: [-20, 20]
    bounds_z: [-30, 22]
    max_height: 1.2
    white_color: [0.12, 0.12, 0.14]
    red_color: [0.06, 0.06, 0.08]
    diffuse: 0.3
    ambient: 0.06
    reflect_base: 0.3
    reflect_mirror: 0.7
    max_depth: 2
    spec_power: 64
    spec_intensity: 0.5
  glass:
    type: glass
    edge: 0.8
    cluster_min: 3
    cluster_max: 9
    size_min: 0.2
    size_max: 0.6
    spread: 0.5
    ior: 1.5
    fresnel_r0: 0.04
    tint_scale: 0.1
    tint_rgb: [0.02, 0.01, 0.005]
    spec_power: 128
    spec_intensity: 0.3
    max_depth: 4
    passthrough_depth: 6
  key_light:
    type: light
    position: [10, 15, 0]
    color: [1.0, 0.7, 0.3]
  fill_light:
    type: light
    position: [-10, 15, -5]
    color: [0.3, 0.5, 1.0]
  inner_chrome:
    type: reflective_sphere
    radius_mult: 0.625
  sphere_glass:
    type: glass_sphere
    radius_mult: 1.25
    ior: 1.5
    fresnel_r0: 0.04
    tint_scale: 0.1
    tint_rgb: [0.02, 0.01, 0.005]
    spec_power: 128
    spec_intensity: 0.3
    max_depth: 4
    passthrough_depth: 6
  sphere_torus:
    type: emissive_torus
    major_mult: 3.125
    minor: 0.07
    intensity: 2.0
  with_love:
    type: text
    string: with love
    position: [-13.5, 9.0, -14.0]
    col_spacing: 0.5
    row_spacing: 0.5
  skmp:
    type: text
    string: skmp
    position: [-3.0, 5.0, -7.0]
    col_spacing: 0.5
    row_spacing: 0.5

materials:
  chrome:
    color: [0.9, 0.75, 0.5]
    diffuse: 0.25
    ambient: 0.06
    reflect_base: 0.25
    reflect_mirror: 0.75
    max_depth: 3
    spec_power: 80
    spec_intensity: 0.7
  silver:
    color: [0.95, 0.8, 0.55]
    scratched_color: [0.5, 0.4, 0.25]
    discolor_scale: 3.0
    diffuse: 0.4
    ambient: 0.1
    reflect_base: 0.5
    reflect_mirror: 0.5
    max_depth: 3
    spec_power: 40
    spec_intensity: 0.5
  scratches:
    uv_scale: 10.0
    layer1:
      frequency: 14.0
      power: 4.0
      intensity: 0.3
    layer2:
      angle_offset: 1.2
      frequency: 22.0
      phase_mult: 1.5
      power: 5.0
      intensity: 0.18
    layer3:
      angle_offset: 2.5
      frequency: 35.0
      phase_mult: 0.5
      power: 6.0
      intensity: 0.1

environment:
  shadow_ambient: 0.1
  sky:
    base_color: [0.06, 0.02, 0.12]
    horizon_threshold: 0.005
    ceiling_height: 25.0
    grid_spacing: 8.0
    glow_width: 0.5
    fade_rate: 0.012
    neon_color: [1.0, 0.15, 0.6]
    neon_intensity: 2.5
  fog:
    density: 0.01
    steps: 32
    noise_x: 0.025
    noise_xz: 0.012
    noise_y: 0.04
    noise_z: 0.03

post_processing:
  bloom:
    radius: 24
    threshold: 0.7
    intensity: 0.7
    gamma: 0.45</textarea>
  </div>
</div>

<script>
var Module = {
  print: function(text) { console.log(text); },
  printErr: function(text) { console.warn(text); }
};
</script>
<script src="nanore.js"></script>
<script>
(function() {
  var canvas = document.getElementById('render-canvas');
  var ctx = canvas.getContext('2d');
  var editor = document.getElementById('yaml-editor');
  var overlay = document.getElementById('overlay');
  var progressFill = document.getElementById('progress-fill');
  var progressText = document.getElementById('progress-text');
  var statusEl = document.getElementById('status');
  var errorBar = document.getElementById('error-bar');
  var renderBtn = document.getElementById('render-btn');

  var isRendering = false;
  var activeTab = 'color';
  var debounceTimer = null;
  var pollTimer = null;
  var colorImageData = null;
  var zbufImageData = null;
  var pendingRender = false;
  var moduleReady = false;
  var t0 = 0;

  // SharedArrayBuffer check
  if (typeof SharedArrayBuffer === 'undefined') {
    document.body.innerHTML = '<div style="padding:40px;color:#ff6080;font-family:monospace">' +
      '<h2>SharedArrayBuffer not available</h2>' +
      '<p style="margin-top:12px;color:#888">This page must be served with these HTTP headers:<br>' +
      '<code style="color:#e0a0d0">Cross-Origin-Opener-Policy: same-origin</code><br>' +
      '<code style="color:#e0a0d0">Cross-Origin-Embedder-Policy: require-corp</code></p></div>';
    return;
  }

  Module.onRuntimeInitialized = function() {
    moduleReady = true;
    statusEl.textContent = 'Ready';
    startRender();
  };

  function callWasm(name) {
    return Module['_' + name];
  }

  function startRender() {
    if (!moduleReady) return;

    if (isRendering) {
      // Cancel current render, queue a new one
      callWasm('cancel_render')();
      pendingRender = true;
      return;
    }

    var yaml = editor.value;
    isRendering = true;
    pendingRender = false;
    renderBtn.disabled = true;
    errorBar.style.display = 'none';
    overlay.style.display = 'flex';
    progressFill.style.width = '0%';
    progressText.textContent = '0%';
    statusEl.textContent = 'Rendering...';
    t0 = performance.now();

    // Allocate YAML string in WASM memory and call start_render
    var yamlBytes = Module.lengthBytesUTF8(yaml) + 1;
    var yamlPtr = Module._malloc(yamlBytes);
    Module.stringToUTF8(yaml, yamlPtr, yamlBytes);
    callWasm('start_render')(yamlPtr);
    Module._free(yamlPtr);

    // Poll for progress and completion
    pollTimer = setInterval(pollRender, 150);
  }

  function pollRender() {
    var pct = callWasm('get_progress')();
    progressFill.style.width = pct + '%';
    progressText.textContent = pct + '%';

    if (callWasm('is_render_done')()) {
      clearInterval(pollTimer);
      pollTimer = null;

      var result = callWasm('get_render_result')();
      isRendering = false;
      renderBtn.disabled = false;
      overlay.style.display = 'none';

      if (result === 0) {
        var elapsed = ((performance.now() - t0) / 1000).toFixed(1);
        statusEl.textContent = 'Done in ' + elapsed + 's';
        captureResults();
        drawActiveTab();
      } else if (result === 1) {
        statusEl.textContent = 'Cancelled';
      } else if (result === -1) {
        showError('YAML parse error');
      } else if (result === -2) {
        showError('Version must be nanore@2');
      }

      if (pendingRender) {
        setTimeout(startRender, 50);
      }
    }
  }

  function showError(msg) {
    errorBar.textContent = msg;
    errorBar.style.display = 'block';
    statusEl.textContent = 'Error';
  }

  function captureResults() {
    var W = callWasm('get_width')();
    var H = callWasm('get_height')();
    canvas.width = W;
    canvas.height = H;

    // Color buffer
    var pixPtr = callWasm('get_pixels_ptr')();
    if (pixPtr) {
      var pix = Module.HEAPU8.subarray(pixPtr, pixPtr + W * H * 3);
      colorImageData = ctx.createImageData(W, H);
      var d = colorImageData.data;
      for (var i = 0; i < W * H; i++) {
        d[i * 4]     = pix[i * 3];
        d[i * 4 + 1] = pix[i * 3 + 1];
        d[i * 4 + 2] = pix[i * 3 + 2];
        d[i * 4 + 3] = 255;
      }
    }

    // Z-buffer
    var zPtr = callWasm('get_zbuf_ptr')();
    if (zPtr) {
      var zbuf = new Float32Array(Module.HEAPF32.buffer, zPtr, W * H);
      var zmin = zbuf[0], zmax = zbuf[0];
      for (var i = 1; i < W * H; i++) {
        if (zbuf[i] < zmin) zmin = zbuf[i];
        if (zbuf[i] > zmax) zmax = zbuf[i];
      }
      var zrange = (zmax - zmin > 1e-6) ? (zmax - zmin) : 1;
      zbufImageData = ctx.createImageData(W, H);
      var zd = zbufImageData.data;
      for (var i = 0; i < W * H; i++) {
        var norm = (zbuf[i] - zmin) / zrange;
        var v = Math.round((1 - norm) * 255);
        if (v < 0) v = 0; if (v > 255) v = 255;
        zd[i * 4] = v;
        zd[i * 4 + 1] = v;
        zd[i * 4 + 2] = v;
        zd[i * 4 + 3] = 255;
      }
    }
  }

  function drawActiveTab() {
    var img = (activeTab === 'color') ? colorImageData : zbufImageData;
    if (img) {
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.putImageData(img, 0, 0);
    }
  }

  // Tab switching
  var tabs = document.querySelectorAll('.tab');
  for (var i = 0; i < tabs.length; i++) {
    tabs[i].addEventListener('click', function() {
      document.querySelector('.tab.active').classList.remove('active');
      this.classList.add('active');
      activeTab = this.getAttribute('data-tab');
      drawActiveTab();
    });
  }

  // Debounced auto-render on edit
  editor.addEventListener('input', function() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(function() {
      startRender();
    }, 1000);
  });

  // Manual render button
  renderBtn.addEventListener('click', function() {
    clearTimeout(debounceTimer);
    startRender();
  });

  // Tab key support in textarea
  editor.addEventListener('keydown', function(e) {
    if (e.key === 'Tab') {
      e.preventDefault();
      var start = this.selectionStart;
      var end = this.selectionEnd;
      this.value = this.value.substring(0, start) + '  ' + this.value.substring(end);
      this.selectionStart = this.selectionEnd = start + 2;
    }
  });
})();
</script>
</body>
</html>
